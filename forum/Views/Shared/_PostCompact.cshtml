@model forum.Models.Post
@using Markdig

<div class="shared-postCompact">
    <div class="top">
        <div class="chips">
            <a asp-controller="Search"
               asp-action="Search"
               asp-route-term="@Model.Category?.Name"
               class="category" style="background-color: @Model.Category?.Color">@Model.Category?.Name</a>

            @if (Model.Tags != null)
            {
                foreach (var tag in Model.Tags)
                {
                    <a asp-controller="Search"
                       asp-action="Search"
                       asp-route-term="@tag.Name"
                       class="tag">
                        @tag.Name
                    </a>
                }
            }
        </div>
        
        <div class="creation-info">
            By
            <span class="user">
                @if (Model.User != null)
                {
                    <a asp-controller="Search"
                       asp-action="Search"
                       asp-route-term="@Model.User.UserName">@Model.User.UserName</a>
                }
                else
                {
                    <span class="deleted-user" title="Deleted user">[deleted user]</span>
                }
            </span>
            @CalculateTimeAgo(Model.DateCreated)
            @if (Model.DateLastEdited != null)
            {
                <span class="last-edited">(edited @CalculateTimeAgo(Model.DateLastEdited.Value))</span>
            }
        </div>
        
        <div class="likes-comments">
            @Model.TotalLikes likes | @Model.Comments?.Count comments
        </div>
    </div>
    <div class="bottom">
        <div class="left-side">
            <div class="title">@Model.Title</div>
            <div class="content">@Html.Raw(Markdown.ToHtml(Model.Content))</div>
        </div>
        <div class="right-side">
            <a asp-controller="Post"
               asp-action="Post"
               asp-route-id="@Model.PostId">
                <i class="fa-solid fa-arrow-right"></i>
            </a>
        </div>
    </div>
</div>

@functions {
    static string CalculateTimeAgo(DateTime date)
    {
        var timeDifference = DateTime.Now - date;

        if (timeDifference.TotalMinutes < 1)
        {
            return "just now";
        }
        if (timeDifference.TotalMinutes < 60)
        {
            var minutesAgo = (int)timeDifference.TotalMinutes;
            return $"{minutesAgo} {(minutesAgo == 1 ? "minute" : "minutes")} ago";
        }
        if (timeDifference.TotalHours < 24)
        {
            var hoursAgo = (int)timeDifference.TotalHours;
            return $"{hoursAgo} {(hoursAgo == 1 ? "hour" : "hours")} ago";
        }
        if (timeDifference.TotalDays < 30)
        {
            var daysAgo = (int)timeDifference.TotalDays;
            return $"{daysAgo} {(daysAgo == 1 ? "day" : "days")} ago";
        }
        if (timeDifference.TotalDays < 365)
        {
            var monthsAgo = (int)(timeDifference.TotalDays / 30);
            return $"{monthsAgo} {(monthsAgo == 1 ? "month" : "months")} ago";
        }
        var yearsAgo = (int)(timeDifference.TotalDays / 365);
        return $"{yearsAgo} {(yearsAgo == 1 ? "year" : "years")} ago";
    }

}